<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบเช็คการส่งงานนักเรียน</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #333;
        }

        .header h1 {
            color: #4a5568;
            margin: 0 0 15px 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header .subtitle {
            color: #718096;
            font-size: 1.2rem;
            margin: 5px 0;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 2px solid #333;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .page {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #333;
        }

        .page.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .student-list {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }

        .student-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-info {
            font-weight: 600;
            color: #4a5568;
        }

        .status-buttons {
            display: flex;
            gap: 10px;
        }

        .status-btn {
            padding: 8px 16px;
            border: 2px solid #333;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .status-btn.submitted {
            background: #48bb78;
            color: white;
        }

        .status-btn.late {
            background: #ed8936;
            color: white;
        }

        .status-btn.missing {
            background: #f56565;
            color: white;
        }

        .status-btn:not(.active) {
            background: white;
            color: #4a5568;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #333;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .chart-container {
            margin: 30px 0;
            height: 400px;
            position: relative;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            font-weight: 600;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #48bb78;
        }

        .status-indicator.disconnected {
            background: #f56565;
        }

        .status-indicator.checking {
            background: #ed8936;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .connection-details {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .connection-test-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            margin-left: 10px;
        }

        .retry-btn {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-buttons {
                grid-template-columns: 1fr;
            }
            
            .student-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .status-buttons {
                justify-content: center;
            }

            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                justify-content: center;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Connection Status -->
  <div class="connection-status" id="connection-status">
   <div class="status-indicator checking" id="status-indicator"></div><span id="status-text">กำลังตรวจสอบการเชื่อมต่อ...</span> <button class="btn connection-test-btn" onclick="testConnection()" id="test-btn"> <i class="fas fa-sync-alt"></i> ทดสอบ </button>
  </div>
  <div class="container"><!-- Header -->
   <div class="header">
    <h1 id="system-title">ระบบเช็คการส่งงานนักเรียน</h1>
    <div class="subtitle" id="school-name">
     โรงเรียนสวรรค์อนันต์วิทยา
    </div>
    <div class="subtitle" id="subject-name">
     วิชาคณิตศาสตร์
    </div>
   </div><!-- Navigation -->
   <div class="nav-buttons">
    <button class="nav-btn active" data-page="dashboard" onclick="showPage('dashboard', this)"> <i class="fas fa-home"></i> หน้าหลัก </button>
    <button class="nav-btn" data-page="checkin" onclick="showPage('checkin', this)"> <i class="fas fa-check-circle"></i> เช็คการส่งงาน </button>
    <button class="nav-btn" data-page="statistics" onclick="showPage('statistics', this)"> <i class="fas fa-chart-bar"></i> สถิติการส่งงาน </button>
    <button class="nav-btn" data-page="students" onclick="showPage('students', this)"> <i class="fas fa-user-plus"></i> เพิ่มรายชื่อนักเรียน </button>
    <button class="nav-btn" data-page="settings" onclick="showPage('settings', this)"> <i class="fas fa-cog"></i> ตั้งค่าการเชื่อมต่อ </button>
   </div><!-- Dashboard Page -->
   <div id="dashboard" class="page active">
    <h2><i class="fas fa-tachometer-alt"></i> แดชบอร์ด</h2>
    <p>ยินดีต้อนรับสู่ระบบเช็คการส่งงานนักเรียน</p>
    <div class="stats-grid">
     <div class="stat-card">
      <div class="stat-number" id="total-students">
       0
      </div>
      <div class="stat-label">
       นักเรียนทั้งหมด
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="total-submitted">
       0
      </div>
      <div class="stat-label">
       ส่งแล้ววันนี้
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="total-late">
       0
      </div>
      <div class="stat-label">
       ส่งช้าวันนี้
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="total-missing">
       0
      </div>
      <div class="stat-label">
       ขาดส่งวันนี้
      </div>
     </div>
    </div>
   </div><!-- Check-in Page -->
   <div id="checkin" class="page">
    <h2><i class="fas fa-check-circle"></i> เช็คการส่งงาน</h2>
    <div class="form-group"><label for="check-date">วันที่:</label> <input type="date" id="check-date" class="form-control">
    </div>
    <div class="form-group"><label for="class-select">ชั้นเรียน:</label> <select id="class-select" class="form-control" onchange="loadStudents()"> <option value="">เลือกชั้นเรียน</option> <option value="ม.1/3">ม.1 ห้อง 1/3</option> <option value="ม.1/5">ม.1 ห้อง 1/5</option> <option value="ม.1/6">ม.1 ห้อง 1/6</option> </select>
    </div>
    <div id="students-checkin" class="student-list"></div><button id="save-att-btn" class="btn btn-success" onclick="saveAttendance()"> <i class="fas fa-save"></i> บันทึกการเช็ค </button>
   </div><!-- Statistics Page -->
   <div id="statistics" class="page">
    <h2><i class="fas fa-chart-bar"></i> สถิติการส่งงาน</h2>
    <div class="form-group"><label for="stats-class">ชั้นเรียน:</label> <select id="stats-class" class="form-control" onchange="loadStatistics()"> <option value="">เลือกชั้นเรียน</option> <option value="ม.1/3">ม.1 ห้อง 1/3</option> <option value="ม.1/5">ม.1 ห้อง 1/5</option> <option value="ม.1/6">ม.1 ห้อง 1/6</option> </select>
    </div>
    <div class="stats-grid">
     <div class="stat-card">
      <div class="stat-number" id="stats-submitted">
       0
      </div>
      <div class="stat-label">
       ส่งแล้ว
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="stats-late">
       0
      </div>
      <div class="stat-label">
       ส่งช้า
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" id="stats-missing">
       0
      </div>
      <div class="stat-label">
       ขาดส่ง
      </div>
    </div>
    </div>
    <div class="chart-container">
     <canvas id="statsChart"></canvas>
    </div>
    <div id="student-stats-list" style="margin-top: 20px;"></div>
   </div><!-- Students Page -->
   <div id="students" class="page">
    <h2><i class="fas fa-user-plus"></i> เพิ่มรายชื่อนักเรียน</h2>
    <form id="student-form" onsubmit="addStudent(event)">
     <div class="form-group"><label for="student-id">เลขที่:</label> <input type="number" id="student-id" class="form-control" required min="1">
     </div>
     <div class="form-group"><label for="student-name">ชื่อ-สกุล:</label> <input type="text" id="student-name" class="form-control" required>
     </div>
     <div class="form-group"><label for="student-class">ชั้นเรียน:</label> <select id="student-class" class="form-control" required> <option value="">เลือกชั้นเรียน</option> <option value="ม.1/3">ม.1 ห้อง 1/3</option> <option value="ม.1/5">ม.1 ห้อง 1/5</option> <option value="ม.1/6">ม.1 ห้อง 1/6</option> </select>
     </div><button type="submit" class="btn btn-success"> <i class="fas fa-plus"></i> เพิ่มนักเรียน </button>
    </form>
    <div id="students-list" class="student-list" style="margin-top: 30px;"></div>
   </div><!-- Settings Page -->
   <div id="settings" class="page">
    <h2><i class="fas fa-cog"></i> ตั้งค่าการเชื่อมต่อ</h2>
    <div class="connection-details">
     <h3>สถานะการเชื่อมต่อ</h3>
     <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
      <div class="status-indicator" id="settings-status-indicator"></div><span id="settings-status-text">กำลังตรวจสอบ...</span> <button class="btn connection-test-btn" onclick="testConnection()"> <i class="fas fa-sync-alt"></i> ทดสอบการเชื่อมต่อ </button>
     </div>
     <div id="connection-info">
      <p><strong>Google Sheets ID:</strong> <code>139yt58Ygys6Raiqn60DPTgU4pJ6Rerx8XIfO7JUMoQY</code></p>
      <p><strong>Apps Script URL:</strong> <code>https://script.google.com/macros/s/AKfycbzrWtqUp2ataPt-6dky4vaM0vW7lvCiLfvzywot47yEQixjWDUV_xFeZESGiZG9sPx6Ng/exec</code></p>
     </div>
     <div id="connection-logs" style="margin-top: 20px;">
      <h4>ประวัติการเชื่อมต่อ</h4>
      <div id="logs-container" style="max-height: 200px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
       <p>กำลังโหลดประวัติ...</p>
      </div><button class="btn" onclick="clearLogs()" style="margin-top: 10px;"> <i class="fas fa-trash"></i> ล้างประวัติ </button>
     </div>
     <div style="margin-top: 20px;">
      <h4>การแก้ไขปัญหา</h4>
      <ul style="text-align: left; margin: 10px 0;">
       <li>ตรวจสอบว่า Google Apps Script ได้รับการ Deploy แล้ว</li>
       <li>ตรวจสอบสิทธิ์การเข้าถึง Google Sheets</li>
       <li>ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต</li>
       <li>ลองรีเฟรชหน้าเว็บ</li>
      </ul><button class="btn retry-btn" onclick="retryConnection()"> <i class="fas fa-redo"></i> ลองเชื่อมต่อใหม่ </button>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            system_title: "ระบบเช็คการส่งงานนักเรียน",
            school_name: "โรงเรียนบ้านสวรรค์อนันต์วิทยา",
            subject_name: "วิชาศิลปศาสตร์"
        };

        const SHEET_ID = '139yt58Ygys6Raiqn60DPTgU4pJ6Rerx8XIfO7JUMoQY';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzrWtqUp2ataPt-6dky4vaM0vW7lvCiLfvzywot47yEQixjWDUV_xFeZESGiZG9sPx6Ng/exec';

        let students = [];
        let attendance = {};
        let currentChart = null;
        let connectionStatus = 'checking';
        let connectionLogs = [];
        let lastConnectionTest = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('check-date').valueAsDate = new Date();
            
            // Initialize connection status
            updateConnectionStatus('checking', 'กำลังตรวจสอบการเชื่อมต่อ...');
            
            // Load initial data and test connection
            testConnection();
            loadConnectionLogs();
        });

        // Element SDK Implementation
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: defaultConfig,
                onConfigChange: async (config) => {
                    document.getElementById('system-title').textContent = config.system_title || defaultConfig.system_title;
                    document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
                    document.getElementById('subject-name').textContent = config.subject_name || defaultConfig.subject_name;
                },
                mapToCapabilities: (config) => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["system_title", config.system_title || defaultConfig.system_title],
                    ["school_name", config.school_name || defaultConfig.school_name],
                    ["subject_name", config.subject_name || defaultConfig.subject_name]
                ])
            });
        }

        // Navigation (รับปุ่มที่คลิกมาด้วยเพื่อกำหนด active)
        function showPage(pageId, btn) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            // Show selected page
            const pageEl = document.getElementById(pageId);
            if (pageEl) pageEl.classList.add('active');

            // Mark button active (ถ้าไม่ส่ง btn จะหาโดย data-page)
            if (btn && btn.classList) {
                btn.classList.add('active');
            } else {
                const fallback = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
                if (fallback) fallback.classList.add('active');
            }

            // Load page-specific data
            if (pageId === 'statistics') {
                loadStatistics();
            } else if (pageId === 'students') {
                if (typeof loadStudentsList === 'function') loadStudentsList();
            } else if (pageId === 'dashboard') {
                updateDashboard();
            } else if (pageId === 'settings') {
                updateLogsDisplay();
            }
        }

        // Connection status management
        function updateConnectionStatus(status, message) {
            connectionStatus = status;
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            const settingsIndicator = document.getElementById('settings-status-indicator');
            const settingsText = document.getElementById('settings-status-text');
            
            // Update main status
            if (indicator && text) {
                indicator.className = `status-indicator ${status}`;
                text.textContent = message;
            }
            
            // Update settings page status
            if (settingsIndicator && settingsText) {
                settingsIndicator.className = `status-indicator ${status}`;
                settingsText.textContent = message;
            }
            
            // Add to logs
            addConnectionLog(status, message);
        }

        function addConnectionLog(status, message) {
            const timestamp = new Date().toLocaleString('th-TH');
            const log = {
                timestamp: timestamp,
                status: status,
                message: message
            };
            
            connectionLogs.unshift(log);
            if (connectionLogs.length > 50) {
                connectionLogs = connectionLogs.slice(0, 50);
            }
            
            // Save to localStorage
            localStorage.setItem('connectionLogs', JSON.stringify(connectionLogs));
            
            // Update logs display
            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            const container = document.getElementById('logs-container');
            if (!container) return;
            
            if (connectionLogs.length === 0) {
                container.innerHTML = '<p>ไม่มีประวัติการเชื่อมต่อ</p>';
                return;
            }
            
            container.innerHTML = connectionLogs.map(log => {
                const statusColor = log.status === 'connected' ? '#48bb78' : 
                                  log.status === 'disconnected' ? '#f56565' : '#ed8936';
                return `
                    <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid ${statusColor}; background: #f9f9f9;">
                        <small style="color: #666;">${log.timestamp}</small><br>
                        <strong>${log.message}</strong>
                    </div>
                `;
            }).join('');
        }

        function loadConnectionLogs() {
            const saved = localStorage.getItem('connectionLogs');
            if (saved) {
                connectionLogs = JSON.parse(saved);
                updateLogsDisplay();
            }
        }

        function clearLogs() {
            connectionLogs = [];
            localStorage.removeItem('connectionLogs');
            updateLogsDisplay();
            addConnectionLog('info', 'ล้างประวัติการเชื่อมต่อแล้ว');
        }

        // Test connection function
        function testConnection() {
            updateConnectionStatus('checking', 'กำลังทดสอบการเชื่อมต่อ...');
            lastConnectionTest = new Date();
            
            // Test with a simple request
            makeJSONPRequest(SCRIPT_URL, {
                action: 'getStudents'
            }, function(response) {
                if (response && response.success !== undefined) {
                    updateConnectionStatus('connected', 'เชื่อมต่อสำเร็จ');
                    // Load data after successful connection
                    loadStudentsData();
                    loadAttendanceData();
                    updateDashboard();
                } else {
                    updateConnectionStatus('disconnected', 'เชื่อมต่อไม่สำเร็จ - ตรวจสอบ Apps Script');
                }
            }, function(error) {
                updateConnectionStatus('disconnected', 'เชื่อมต่อไม่สำเร็จ - ' + error);
            });
            
            // Timeout after 10 seconds
            setTimeout(() => {
                if (connectionStatus === 'checking') {
                    updateConnectionStatus('disconnected', 'หมดเวลาการเชื่อมต่อ');
                }
            }, 10000);
        }

        function retryConnection() {
            testConnection();
        }

        // Enhanced JSONP helper function with error handling
        function makeJSONPRequest(url, data, callback, errorCallback) {
            const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
            let timeoutId;
            
            window[callbackName] = function(response) {
                clearTimeout(timeoutId);
                delete window[callbackName];
                document.body.removeChild(script);
                callback(response);
            };
            
            const script = document.createElement('script');
            const params = new URLSearchParams(data);
            params.append('callback', callbackName);
            script.src = url + '?' + params.toString();
            
            script.onerror = function() {
                clearTimeout(timeoutId);
                delete window[callbackName];
                document.body.removeChild(script);
                if (errorCallback) {
                    errorCallback('Script loading failed');
                }
            };
            
            // Set timeout
            timeoutId = setTimeout(() => {
                delete window[callbackName];
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
                if (errorCallback) {
                    errorCallback('Request timeout');
                }
            }, 10000);
            
            document.body.appendChild(script);
        }

        // Load students data
        function loadStudentsData() {
            if (connectionStatus !== 'connected') {
                addConnectionLog('warning', 'พยายามโหลดข้อมูลนักเรียนขณะไม่ได้เชื่อมต่อ');
                return;
            }
            
            makeJSONPRequest(SCRIPT_URL, {
                action: 'getStudents'
            }, function(response) {
                if (response.success) {
                    // Normalize student objects to { id, name, class }
                    const raw = response.data || [];
                    students = raw.map(s => {
                        const idVal = s.id ?? s.student_number ?? s.studentId ?? s.no ?? s.studentNo ?? s.number;
                        const nameVal = s.name ?? s.student_name ?? s.fullname ?? s.studentName ?? s.displayName ?? '';
                        const classVal = s.class ?? s.class_name ?? s.classroom ?? s.group ?? '';
                        return {
                            id: String(idVal ?? '').trim(),
                            name: String(nameVal ?? '').trim(),
                            class: String(classVal ?? '').trim()
                        };
                    });
                    updateDashboard();
                    addConnectionLog('connected', `โหลดข้อมูลนักเรียน ${students.length} คน`);
                } else {
                    addConnectionLog('disconnected', 'โหลดข้อมูลนักเรียนไม่สำเร็จ');
                }
            }, function(error) {
                addConnectionLog('disconnected', 'เกิดข้อผิดพลาดในการโหลดข้อมูลนักเรียน: ' + error);
            });
        }
        
        // Create / update stats chart (Chart.js)
        function updateChart(submitted, late, missing) {
            try {
                const canvas = document.getElementById('statsChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                currentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ส่งแล้ว', 'ส่งช้า', 'ขาดส่ง'],
                        datasets: [{
                            data: [submitted, late, missing],
                            backgroundColor: ['#48bb78', '#ed8936', '#f56565']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            } catch (e) {
                console.error('[updateChart] error', e);
            }
        }

        // Load attendance data
        function loadAttendanceData() {
            if (connectionStatus !== 'connected') {
                addConnectionLog('warning', 'พยายามโหลดข้อมูลการเช็คขณะไม่ได้เชื่อมต่อ');
                return;
            }
            
            makeJSONPRequest(SCRIPT_URL, {
                action: 'getAttendance'
            }, function(response) {
                if (response.success) {
                    attendance = response.data || {};
                    updateDashboard();
                    const recordCount = Object.keys(attendance).length;
                    addConnectionLog('connected', `โหลดข้อมูลการเช็ค ${recordCount} วัน`);
                } else {
                    addConnectionLog('disconnected', 'โหลดข้อมูลการเช็คไม่สำเร็จ');
                }
            }, function(error) {
                addConnectionLog('disconnected', 'เกิดข้อผิดพลาดในการโหลดข้อมูลการเช็ค: ' + error);
            });
        }

        // Load students for check-in
        function loadStudents() {
            const selectedClass = document.getElementById('class-select').value;
            const container = document.getElementById('students-checkin');
            
            if (!selectedClass) {
                container.innerHTML = '<p>กรุณาเลือกชั้นเรียน</p>';
                return;
            }
            
            const classStudents = students.filter(s => s.class === selectedClass);
            const today = document.getElementById('check-date').value;
            
            if (classStudents.length === 0) {
                container.innerHTML = '<p>ไม่พบนักเรียนในชั้นเรียนนี้</p>';
                return;
            }
            
            container.innerHTML = classStudents.map(student => {
                const currentStatus = (attendance[today] && attendance[today][student.id]) || '';
                
                return `
                    <div class="student-item" data-student-id="${student.id}">
                        <div class="student-info">
                            ${student.id}. ${student.name}
                        </div>
                        <div class="status-buttons">
                            <button class="status-btn submitted ${currentStatus === 'submitted' ? 'active' : ''}" 
                                    onclick="setStatus('${student.id}', 'submitted', this)">
                                <i class="fas fa-check"></i> ส่งแล้ว
                            </button>
                            <button class="status-btn late ${currentStatus === 'late' ? 'active' : ''}" 
                                    onclick="setStatus('${student.id}', 'late', this)">
                                <i class="fas fa-clock"></i> ส่งช้า
                            </button>
                            <button class="status-btn missing ${currentStatus === 'missing' ? 'active' : ''}" 
                                    onclick="setStatus('${student.id}', 'missing', this)">
                                <i class="fas fa-times"></i> ขาดส่ง
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // update counts when switching class/date
            updateDashboard();
        }

        // Set student status
        function setStatus(studentId, status, btn) {
            const today = document.getElementById('check-date').value || new Date().toISOString().split('T')[0];

            if (!attendance[today]) attendance[today] = {};

            attendance[today][studentId] = status;

            // Update UI: find student item and toggle active class
            let studentItem = null;
            if (btn && btn.closest) {
                studentItem = btn.closest('.student-item');
            } else {
                studentItem = document.querySelector(`.student-item[data-student-id="${studentId}"]`);
            }

            if (studentItem) {
                const buttons = studentItem.querySelectorAll('.status-btn');
                buttons.forEach(b => b.classList.remove('active'));
                if (btn && btn.classList) btn.classList.add('active');
                else {
                    const sel = studentItem.querySelector(`.status-btn.${status}`);
                    if (sel) sel.classList.add('active');
                }
            }

            // อัพเดตตัวเลขเรียลไทม์
            updateDashboard();
        }

        // Update dashboard numbers (total students, today submitted/late/missing)
        function updateDashboard() {
            try {
                // total students
                const totalEl = document.getElementById('total-students');
                if (totalEl) totalEl.textContent = students.length || 0;

                // counts for selected date
                const date = document.getElementById('check-date').value || new Date().toISOString().split('T')[0];
                const todayData = attendance[date] || {};
                let submitted = 0, late = 0, missing = 0;
                Object.values(todayData).forEach(s => {
                    if (s === 'submitted') submitted++;
                    else if (s === 'late') late++;
                    else if (s === 'missing') missing++;
                });

                const subEl = document.getElementById('total-submitted');
                const lateEl = document.getElementById('total-late');
                const missEl = document.getElementById('total-missing');
                if (subEl) subEl.textContent = submitted;
                if (lateEl) lateEl.textContent = late;
                if (missEl) missEl.textContent = missing;
            } catch (e) {
                console.error('[updateDashboard] error', e);
            }
        }

        // Save attendance (send to Apps Script) and report status to user
        function saveAttendance() {
            const btn = document.getElementById('save-att-btn');
            const originalHtml = btn ? btn.innerHTML : null;
            try {
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';
                }

                const date = document.getElementById('check-date').value || new Date().toISOString().split('T')[0];
                const className = document.getElementById('class-select').value;
                if (!className) {
                    Swal.fire({ icon: 'warning', title: 'เลือกชั้นเรียน', text: 'กรุณาเลือกชั้นเรียนก่อนบันทึก' });
                    return;
                }

                const dataToSave = attendance[date] || {};
                if (Object.keys(dataToSave).length === 0) {
                    Swal.fire({ icon: 'warning', title: 'ไม่มีข้อมูล', text: 'ยังไม่มีการลงสถานะของนักเรียนสำหรับวันที่นี้' });
                    return;
                }

                // Request payload: action, date, class, data (JSON string)
                makeJSONPRequest(SCRIPT_URL, {
                    action: 'saveAttendance',
                    date: date,
                    class: className,
                    data: JSON.stringify(dataToSave)
                }, function(response) {
                    if (btn) { btn.disabled = false; btn.innerHTML = originalHtml; }
                    if (response && response.success) {
                        addConnectionLog('connected', `บันทึกการเช็ค ${date} ห้อง ${className} สำเร็จ`);
                        Swal.fire({ icon: 'success', title: 'บันทึกแล้ว', text: 'บันทึกการเช็คเรียบร้อยแล้ว' });
                    } else {
                        const msg = (response && response.error) ? response.error : 'ไม่สามารถบันทึกได้';
                        addConnectionLog('disconnected', `บันทึกไม่สำเร็จ: ${msg}`);
                        Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: msg });
                    }
                }, function(error) {
                    if (btn) { btn.disabled = false; btn.innerHTML = originalHtml; }
                    addConnectionLog('disconnected', 'เกิดข้อผิดพลาดขณะบันทึก: ' + error);
                    Swal.fire({ icon: 'error', title: 'ข้อผิดพลาด', text: 'เกิดข้อผิดพลาดขณะบันทึก: ' + error });
                });
            } catch (e) {
                if (btn) { btn.disabled = false; btn.innerHTML = originalHtml; }
                console.error('[saveAttendance] exception', e);
                addConnectionLog('disconnected', 'Exception ขณะบันทึก: ' + (e && e.message));
                Swal.fire({ icon: 'error', title: 'ข้อผิดพลาด', text: 'เกิดข้อผิดพลาดขณะบันทึก' });
            }
        }

        // Load statistics and render per-student table + chart
        function loadStatistics() {
            const selectedClass = document.getElementById('stats-class') ? document.getElementById('stats-class').value : '';
            const container = document.getElementById('student-stats-list');
            // reset
            if (!selectedClass) {
                document.getElementById('stats-submitted').textContent = '0';
                document.getElementById('stats-late').textContent = '0';
                document.getElementById('stats-missing').textContent = '0';
                if (container) container.innerHTML = '<p>เลือกชั้นเรียนเพื่อดูสถิติรายบุคคล</p>';
                if (currentChart) { currentChart.destroy(); currentChart = null; }
                return;
            }

            const classStudents = students.filter(s => s.class === selectedClass);
            if (!classStudents.length) {
                if (container) container.innerHTML = '<p>ไม่พบนักเรียนในชั้นเรียนนี้</p>';
                document.getElementById('stats-submitted').textContent = '0';
                document.getElementById('stats-late').textContent = '0';
                document.getElementById('stats-missing').textContent = '0';
                if (currentChart) { currentChart.destroy(); currentChart = null; }
                return;
            }

            // tally
            let submitted = 0, late = 0, missing = 0;
            const perStudent = {};
            classStudents.forEach(s => perStudent[s.id] = { submitted:0, late:0, missing:0, total:0, name: s.name, id: s.id });

            Object.values(attendance || {}).forEach(day => {
                if (!day) return;
                classStudents.forEach(s => {
                    const status = day[s.id];
                    if (!status) return;
                    perStudent[s.id].total++;
                    if (status === 'submitted') { perStudent[s.id].submitted++; submitted++; }
                    else if (status === 'late') { perStudent[s.id].late++; late++; }
                    else if (status === 'missing') { perStudent[s.id].missing++; missing++; }
                });
            });

            document.getElementById('stats-submitted').textContent = submitted;
            document.getElementById('stats-late').textContent = late;
            document.getElementById('stats-missing').textContent = missing;

            // update chart
            updateChart(submitted, late, missing);

            // build table
            const rows = classStudents.slice().sort((a,b) => Number(a.id) - Number(b.id)).map(s => {
                const p = perStudent[s.id] || { submitted:0, late:0, missing:0, total:0, name:s.name, id:s.id };
                return `
                    <tr>
                        <td style="padding:8px;border-bottom:1px solid #eee;text-align:center">${escapeHtml(p.id)}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee">${escapeHtml(p.name)}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;text-align:center">${p.submitted}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;text-align:center">${p.late}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;text-align:center">${p.missing}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;text-align:center">${p.total}</td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                <div style="overflow:auto; background:#fff; padding:12px; border-radius:8px; border:1px solid #eee;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.95rem;">
                        <thead>
                            <tr style="background:#f5f7fa;">
                                <th style="padding:10px;border-bottom:2px solid #ddd;text-align:center">เลขที่</th>
                                <th style="padding:10px;border-bottom:2px solid #ddd;text-align:left">ชื่อ</th>
                                <th style="padding:10px;border-bottom:2px solid #ddd;text-align:center">ส่งแล้ว</th>
                                <th style="padding:10px;border-bottom:2px solid #ddd;text-align:center">ส่งช้า</th>
                                <th style="padding:10px;border-bottom:2px solid #ddd;text-align:center">ขาดส่ง</th>
                                <th style="padding:10px;border-bottom:2px solid #ddd;text-align:center">รวม</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;

            if (container) container.innerHTML = tableHtml;
        }

        // helper: escape HTML
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9967c94bc3532dc0',t:'MTc2MTc5NDUyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
